<!DOCTYPE html>
<html>
	<head>
		<title>Revel Test Runner</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<link href="{{url `Root`}}/@tests/public/css/bootstrap.min.css" type="text/css" rel="stylesheet"></link>
		<link href="{{url `Root`}}/@tests/public/css/github.css" type="text/css" rel="stylesheet"></link>
		<script src="{{url `Root`}}/@tests/public/js/jquery-1.9.1.min.js" type="text/javascript"></script>
		<script src="{{url `Root`}}/@tests/public/js/bootstrap.min.js" type="text/javascript"></script>
		<script src="{{url `Root`}}/@tests/public/js/highlight.pack.js" type="text/javascript"></script>
		<style>
		header { padding:20px 0; background-color:#ADD8E6 }
		button.file-test { margin-bottom: 4px; margin-left: 6px }
		table.tests tr { border-bottom: 1px solid #ddd; background-color: #f9f9f9; }
		.table > tbody > tr > td { vertical-align: middle; }
		.passed td { background-color: #90EE90 !important; }
		.failed td { background-color: #FFB6C1 !important; }
		.tests td.name, .tests td.result { }
		pre { font-size:10px; white-space: pre; }
		.name { width: 25%; }
		.w100 { width: 100%; }
		</style>
	</head>
	<body>
		<header>
			<div class="container">
				<table class="w100"><tr><td>
					<h1>Test Runner <small>- Run your unit tests here.</small> </h1>
				</td><td style="padding-left:150px;" class="text-right">
					<button class="btn btn-success" all-tests="">Run All Tests</button>
				</td></tr></table>
			</div>
		</header>

		<div class="container">
			<br>
			{{range .testSuites}}
			{{ $testFile := .Name }}
			<button class="btn btn-xs btn-success file-test" test-file="{{.Name}}" class="btn btn-success btn-xs">Run</button>
			<span class="h4">&nbsp;{{.Name}}</span>
				<table class="table table-condensed table-striped2 tests" suite="{{.Name}}">
					{{range .Tests}}
						<tr>
							<td class="name"><button data-test-file="{{$testFile}}" test="{{.Name}}" class="btn btn-success btn-xs">Run</button>&nbsp;&nbsp;{{ .Name }}</td>
							<td class="result"></td>
						</tr>
					{{end}}
				</table>
			{{end}}
		</div>

	<script>
	var buttons = [];
	var running;

	$("button[test]").click(function() {
		var button = $(this).addClass("disabled").text("Running");
		addToQueue(button);
	});

	$("button[test-file]").click(function() {
		var testfile = $(this).attr('test-file');
		$("button").each(function() {
			if ($(this).data("test-file") == testfile)
			    $(this).click();
		});
	});

	$("button[all-tests]").click(function() {
		var button = $(this).addClass("disabled").text("Running");
		$("button[test]").click();
	});

	function addToQueue(button) {
		buttons.push(button);
		if (!running) {
			running = true;
			nextTest();
		}
	}

	function nextTest() {
		if (buttons.length == 0) {
			running = false;
		} else {
			var next = buttons.shift();
			runTest(next);
		}
	}

	function runTest(button) {
		var suite = button.parents("table").attr("suite");
		var test = button.attr("test");
		var row = button.parents("tr");
		var resultCell = row.children(".result");
		$.ajax({
			dataType: "json",
			url: "{{url `Root`}}/@tests/"+suite+"/"+test,
			success: function(result) {
				row.attr("class", result.Passed ? "passed" : "failed");
				if (result.Passed) {
					resultCell.html("");
				} else {
					resultCell.html(result.ErrorHtml);

					$("#result_" + suite + "_" + test + " pre code").each(function(i, block) {
						hljs.highlightBlock(block);
					});
				}
				button.removeClass("disabled").text("Run");
				if (buttons.length == 0) {
					$("button[all-tests]").removeClass("disabled").text("Run All Tests");
				}
				nextTest();
			}
		});
	}
	</script>

	</body>
</html>
